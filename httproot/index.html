<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <script src="https://cdn.jsdelivr.net/npm/animejs/lib/anime.iife.min.js"></script>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
    <div id="game">
        <div class="fullscreen center-children">
            <img id="plate" src="/img/Tree_Of_Life 2.png" alt="plate">
            <img id="spinner" src="/img/spinner.png" alt="spinner" onclick="spin(this)">
        </div>
        <div id="card-container" class="fullscreen horizontal-layout">
            <div id="card-1" class="card disabled">
                <div class="card-front">
                    <img src="" alt="">
                </div>
                <div class="card-back">
                    <img src="" alt="">
                    <div class="more-info disabled">
                        <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                        <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                    </div>
                </div>
            </div>
            <div id="card-2" class="card disabled">
                <div class="card-front">
                    <img src="" alt="">
                </div>
                <div class="card-back">
                    <img src="" alt="">
                    <div class="more-info disabled">
                        <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                        <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                    </div>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <div class="card-front">
                    <img src="" alt="">
                </div>
                <div class="card-back">
                    <img src="" alt="">
                    <div class="more-info disabled">
                        <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                        <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                    </div>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <div class="card-front">
                    <img src="" alt="">
                </div>
                <div class="card-back">
                    <img src="" alt="">
                    <div class="more-info disabled">
                        <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                        <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                    </div>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <div class="card-front">
                    <img src="" alt="">
                </div>
                <div class="card-back">
                    <img src="" alt="">
                    <div class="more-info disabled">
                        <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                        <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { animate, utils, stagger } = anime;
        let rotation = 0;
        let hasSpun = false;
        // let spinAnimationDuration = 10 * 1000;
        let spinAnimationDuration = 1000;

        const audioClips = [
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
        ]

        function spin(element) {
            if (!hasSpun) {
                hasSpun = true;

                const sheet = document.styleSheets[0];
                
                const randomIndex = Math.floor((Math.random() * 5));
                
                document.getElementById('spinner').classList.add('no-animation')

                const monthMoonIndex = Math.floor((Math.random() * 32));
                const cardIndex = Math.floor((Math.random() * 5))
                utils.$('.card').forEach((e, i) => {
                    if (i == randomIndex) {
                        const imageIndex = i * 32 + monthMoonIndex;
                        e.querySelector('.card-back img').src = `/img/card-0.25x-${String(imageIndex)}.jpg`;
                    } else {
                        e.querySelector('.card-back img').src = `/img/card-blurred-0.jpg`;
                        e.querySelector('.more-info').classList.remove('disabled');
                    }
                    e.querySelector('.card-front img').src = `/img/stap-${i + 1}.png`;
                    e.style.transformOrigin = `${mapIndexTo01(i) * 100}% center`;
                });

                const anglePerIndex = 360 / 32.0;
                const additionalRotations = Math.round(2 + Math.random() * 5) * 360;
                rotation = additionalRotations + monthMoonIndex * anglePerIndex;
                $spinner = utils.$('#spinner');
                animate($spinner, {
                    rotate: rotation,
                    ease: 'out(4)',
                    duration: spinAnimationDuration,
                }).then(() => {
                    utils.$('.card').forEach((e, i) => {
                        const fadeInDuration = 600;
                        e.classList.remove('disabled')
                        animate(e, {
                            translateX: [`${-50 * i + 50}%`, '0%'],
                            translateY: ['400%' ,'0%'],
                            rotateX: ['-90deg', '0deg'],
                            easing: 'easeOutExpo',
                            duration: fadeInDuration,
                            delay: i * (fadeInDuration * 0.4),
                            composition: 'blend',
                            onBegin: () => { 
                                audioClips[i].volume = 0.2;
                                audioClips[i].play() 
                            },
                            onComplete: () => {
                                const rotationAmplitude = 2
                                animate(e, {
                                    rotate: [
                                        `-${rotationAmplitude}deg`, 
                                        `${rotationAmplitude}deg`],
                                    duration: 5 * 1000,
                                    delay: -utils.random(0, 5 * 1000),
                                    loop: true,
                                    alternate: true,
                                    composition: 'blend',
                                    ease: 'inOutSine',
                                })
                                animate(e, {
                                    translateX: [`-5px`,'5px'],
                                    translateY: ['-5px','5px'],
                                    duration: 5 * 1000,
                                    delay: -utils.random(0, 5 * 1000),
                                    loop: true,
                                    alternate: true,
                                    ease: 'inOutSine',
                                    composition: 'blend',
                                })
                                
                                if (i == randomIndex) {
                                    animate(e, {
                                        rotateX: 180,
                                        duration: 800,
                                        easing: 'easeInOutQuad'
                                    });
                                } else {
                                    e.addEventListener('mouseenter', () => {
                                        animate(e, {
                                            rotateX: 180,
                                            duration: 800,
                                            easing: 'easeInOutQuad'
                                        });
                                    });
    
                                    e.addEventListener('mouseleave', () => {
                                        animate(e, {
                                            rotateX: 0,
                                            duration: 800,
                                            easing: 'easeInOutQuad'
                                        });
                                    });
                                }
                            },
                        })
                    })
                });
                
                window.addEventListener('resize', OnResize);
    
                function OnResize() {
                    const sheet = document.styleSheets[0];
                    const e = utils.$('.card')[0];
                    
                    const element_width = e.offsetWidth;  // before transform
                    const element_height = e.offsetHeight; // before transform
                    const vw = window.innerWidth;   // viewport width in px
                    const vh = window.innerHeight;  // viewport height in px
                    const hfraction = vh / element_height;
                    const vfraction = vw / element_width;
                    const minScale = Math.min(hfraction, vfraction) * 0.9;

                    // Loop through rules to find the one you want
                    for (let i = 0; i < sheet.cssRules.length; i++) {
                        const rule = sheet.cssRules[i];
                        if (rule.selectorText === '.card:hover') {
                            rule.style.scale = `${Math.floor(minScale * 100)}%`;
                        }
                    }
                }
                OnResize();
            }
        }

        function restart() {
            location.reload();
        }

        function mapIndexTo01(i, n = 5) {
            return i / (n - 1);
        }
    </script>
</body>
</html>