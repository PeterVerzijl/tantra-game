<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <script src="https://cdn.jsdelivr.net/npm/animejs/lib/anime.iife.min.js"></script>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
    <div id="game">
        <div class="fullscreen center-children">
            <img id="plate" src="/img/Tree_Of_Life 2.png" alt="plate">
            <img id="spinner" src="/img/spinner.png" alt="spinner" onclick="spin(this)">
        </div>
        <div id="card-container" class="fullscreen horizontal-layout">
            <div id="card-1" class="card disabled">
                <img src="" alt="">
                <div class="more-info disabled">
                    <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                    <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                </div>
            </div>
            <div id="card-2" class="card disabled">
                <img src="" alt="">
                <div class="more-info disabled">
                    <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                    <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <img src="" alt="">
                <div class="more-info disabled">
                    <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                    <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <img src="" alt="">
                <div class="more-info disabled">
                    <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                    <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                </div>
            </div>
            <div id="card-3" class="card disabled">
                <img src="" alt="">
                <div class="more-info disabled">
                    <p>Learn more about GeoMystics?<br>Or discover the rest of your path?</p>
                    <a class="button" href="https://geo-mystics.com/" target="_blank">Explore</a>
                </div>
            </div>
        </div>
        <div class="fullscreen">
            <!-- <button onclick="restart()">Replay</button> -->
        </div>
    </div>

    <script>
        const { animate, utils } = anime;
        let rotation = 0;
        let hasSpun = false;
        // let spinAnimationDuration = 10 * 1000;
        let spinAnimationDuration = 1000;

        function spin(element) {
            if (!hasSpun) {
                hasSpun = true;

                const sheet = document.styleSheets[0];
                
                const randomIndex = Math.floor((Math.random() * 5));
                
                const monthMoonIndex = Math.floor((Math.random() * 32));
                utils.$('.card').forEach((e, i) => {
                    if (i == randomIndex) {
                        const imageIndex = i * 32 + monthMoonIndex;
                        e.querySelector('img').src = `/img/card-0.25x-${String(imageIndex)}.jpg`;
                    } else {
                        e.querySelector('img').src = `/img/card-blurred-0.jpg`;
                        e.querySelector('.more-info').classList.remove('disabled');
                    }
                    e.style.transformOrigin = `${mapIndexTo01(i) * 100}% center`;
                });

                const anglePerIndex = 360 / 32.0;
                const additionalRotations = Math.round(2 + Math.random() * 5) * 360;
                rotation = additionalRotations + monthMoonIndex * anglePerIndex;
                $spinner = utils.$('#spinner');
                animate($spinner, {
                    rotate: rotation,
                    ease: 'out(4)',
                    duration: spinAnimationDuration,
                }).then(() => {
                    utils.$('.card').forEach((e, i) => {
                        e.classList.remove('disabled');
                        setTimeout(() => {
                            e.classList.add('bob');
                        }, 1 * 1000)
                    });
                });
                
                window.addEventListener('resize', OnResize);
    
                function OnResize() {
                    const sheet = document.styleSheets[0];
                    const e = utils.$('.card')[0];
                    
                    const element_width = e.offsetWidth;  // before transform
                    const element_height = e.offsetHeight; // before transform
                    const vw = window.innerWidth;   // viewport width in px
                    const vh = window.innerHeight;  // viewport height in px
                    const hfraction = vh / element_height;
                    const vfraction = vw / element_width;
                    const minScale = Math.min(hfraction, vfraction) * 0.9;

                    // Loop through rules to find the one you want
                    for (let i = 0; i < sheet.cssRules.length; i++) {
                        const rule = sheet.cssRules[i];
                        if (rule.selectorText === '.card:hover') {
                            rule.style.scale = `${Math.floor(minScale * 100)}%`;
                        }
                    }
                }
                OnResize();
            }
        }

        function restart() {
            location.reload();
        }

        function mapIndexTo01(i, n = 5) {
            return i / (n - 1);
        }
    </script>
</body>
</html>