<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <script src="https://cdn.jsdelivr.net/npm/animejs/lib/anime.iife.min.js"></script>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
    <div id="game">
        <div class="fullscreen center-children">
            <img id="plate" src="/img/Tree_Of_Life 2.png" alt="plate">
            <img id="spinner" src="/img/spinner.png" alt="spinner" onclick="spin(this)">
        </div>
        <div id="card-container" class="fullscreen horizontal-layout">
            <div id="card-1" class="card disabled"><img src="" alt=""></div>
            <div id="card-2" class="card disabled"><img src="" alt=""></div>
            <div id="card-3" class="card disabled"><img src="" alt=""></div>
            <div id="card-3" class="card disabled"><img src="" alt=""></div>
            <div id="card-3" class="card disabled"><img src="" alt=""></div>
        </div>
        <div class="fullscreen">
            <!-- <button onclick="restart()">Replay</button> -->
        </div>
    </div>

    <script>
        const { animate, utils, stagger } = anime;
        let rotation = 0;
        let hasSpun = false;
        // let spinAnimationDuration = 10 * 1000;
        let spinAnimationDuration = 1000;

        const audioClips = [
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
            new Audio('/audio/card-slide-6.ogg'),
        ]

        function spin(element) {
            if (!hasSpun) {
                hasSpun = true;

                const monthMoonIndex = Math.floor((Math.random() * 32));
                const cardIndex = Math.floor((Math.random() * 5))
                utils.$('.card').forEach((e, i) => {
                    const imageIndex = i * 32 + monthMoonIndex;
                    const img = e.querySelector('img')
                    if (i == cardIndex) {
                        img.src = `/img/card-0.25x-${String(imageIndex)}.jpg`;
                    } else {
                        img.src = `/img/card-blur.jpg`;
                    }
                });

                const anglePerIndex = 360 / 32.0;
                const additionalRotations = Math.round(2 + Math.random() * 5) * 360;
                rotation = additionalRotations + monthMoonIndex * anglePerIndex;
                $spinner = utils.$('#spinner');
                animate($spinner, {
                    rotate: rotation,
                    ease: 'out(4)',
                    duration: spinAnimationDuration,
                }).then(() => {
                    utils.$('.card').forEach((e, i) => {
                        const fadeInDuration = 600;
                        e.classList.remove('disabled')
                        animate(e, {
                            translateX: [`${-50 * i + 50}%`, '0%'],
                            translateY: ['400%' ,'0%'],
                            rotateX: ['-90deg', '0deg'],
                            easing: 'easeOutExpo',
                            duration: fadeInDuration,
                            delay: i * (fadeInDuration * 0.4),
                            composition: 'blend',
                            onBegin: () => { 
                                audioClips[i].volume = 0.2;
                                audioClips[i].play() 
                            },
                            onComplete: () => {
                                const rotationAmplitude = 2
                                animate(e, {
                                    rotate: [
                                        `-${rotationAmplitude}deg`, 
                                        `${rotationAmplitude}deg`],
                                    duration: 5 * 1000,
                                    delay: -utils.random(0, 5 * 1000),
                                    loop: true,
                                    alternate: true,
                                    composition: 'blend',
                                    ease: 'inOutSine',
                                })
                                animate(e, {
                                    translateX: [`-5px`,'5px'],
                                    translateY: ['-5px','5px'],
                                    duration: 5 * 1000,
                                    delay: -utils.random(0, 5 * 1000),
                                    loop: true,
                                    alternate: true,
                                    ease: 'inOutSine',
                                    composition: 'blend',
                                })
                            },
                        })
                    })
                });
            }
        }

        function restart() {
            location.reload();
        }
    </script>
</body>
</html>